<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="node_modules/bootstrap/dist/css/bootstrap.min.css">
    <title>Grading with LLMs</title>
</head>
<body>
    <!-- Stylesheets  -->
    <script src="node_modules/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>

    <div class="container" id="form_object">
        <h1>Grading with LLMs</h1>
        <!-- The form -->
        <form onsubmit="sendAll(event)">
            <label for="question">Please write here the question that you want to get checked:</label> <br> <br>
            <textarea class="form-control w-50 mb-4" id="question" name="question" rows="2" style="resize: none"></textarea>

            <label for="sampleSolution">Please write here the perfect answer:</label><br><br>
            <textarea class="form-control w-50 mb-4" id="sampleSolution" name="sampleSolution" rows="3" style="resize: none">

            </textarea>
             <div class="form-check">
                <input class="form-check-input" type="checkbox" value="" id="points_check">
                <label class="form-check-label" for="points_check">
                    Do you want to add points?
                </label>
            </div><br>
            <div class="container" id="points_label" style="display: none; padding-left: 0" >
                <label for="points">Choose the possible points for the question
                </label><br><br>
                <input type="number" id="points" step="0.5" min="0.5" value="0.5"> Points
                <br><br>
            </div>


            <label for="studentAnswers">Upload your student answers here</label><br>
            <p>(separate the answers with ###)</p>
            <input class="form-control" type="file" id="studentAnswers"> <br>
            <label for="keywords">You can enter keywords if necessary here:</label><br><br>
            <input type="text" id="keywords" class="form-control" placeholder="keyword1;keyword2"><br>
            <button class="btn btn-primary" type="submit">submit</button>
        </form>
        <div id="snackbar">Request sent to server</div>
    </div>
    <script>

        $(document).ready(function() {
            $('#points_check').change(function() {
                if(this.checked) {
                    $('#points_label').show();
                } else {
                    $('#points_label').hide();
                }
            });
        });
        function showToast() {
          // Get the snackbar DIV
          var x = document.getElementById("snackbar");

          // Add the "show" class to DIV
          x.className = "show";

          // After 3 seconds, remove the show class from DIV
          setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000);
        }
    </script>
    <script>
        //for hhtprequest
        var xhr = null;

        /*
        This function retrieves the file with the id "studentAnswers" and uploads the file to
        http://localhost:6969/file
        */
        function sendFile(){
            var file = document.getElementById("studentAnswers").files[0];

            if(file.type != "text/plain"){
                alert("Only .txt files are allowed!");
                return;
            }

            //the file stored in formData
            var formData = new FormData();
            formData.append("file", file);

            //the call to upload the file
            fetch('http://localhost:6969/file', {
            method: 'POST',
            body: formData
            })
            .then(response => response.json)
            .then(result => {
            console.log("Success:", result);
            })
            .catch(error => {
                console.error("Error:", error)
            });
        }

        /*
        This function is to ensure xhr has a value
        */
        getXmlHttpRequestObject = function () {
            if (!xhr) {
                // Create a new XMLHttpRequest object
                xhr = new XMLHttpRequest();
            }
            return xhr;
        };
        /*
        to check the status
        */
        function sendDataCallback() {
            // Check response is ready or not
            if (xhr.readyState == 4 && xhr.status == 201) {
                console.log("Data creation response received!");
                dataDiv = document.getElementById('sent-data-container');
                // Send response Text
                console.log(xhr.responseText);
            }
        }

        /*
        Here everything besides the file will be stored to be uploaded in a different function
        */
        function getFormData() {

            var question = document.getElementById('question').value;
            var sampleSolution = document.getElementById('sampleSolution').value;
            var keywords = document.getElementById('keywords').value;
            var pointsChecked = document.getElementById('points_check').checked;// For checkbox, use 'checked' instead of 'value'
            var points = document.getElementById('points').value;

            return dataToSend = {
                question: question,
                sampleSolution: sampleSolution,
                keywords: keywords,
                pointsChecked: pointsChecked,
                points: points,
            };
        }
        function sendAll(event) {
            if(document.getElementById('question').value === ""){
                alert("Question field should not be empty")
                return;
            }
            event.preventDefault();
            const file = document.getElementById("studentAnswers").files[0];

            if(file.type !== "text/plain"){
                alert("Only .txt files are allowed!");
                return;
            }
            const formData = new FormData();

            const jsonBlob = new Blob([JSON.stringify(getFormData())],{type: 'application/json'});
            formData.append('metadata',jsonBlob);

            formData.append('file', file, file.name);

            showToast();

            fetch("http://localhost:6969/upload", {
                method: 'POST',
                body: formData
            }).then(response => response.json)
            .then(result => {
            console.log("Success:", result);
            })
            .catch(error => {
                console.error("Error:", error)
            });
        }

        /*
        Here the main upload takes place when the user clicks "submit"
        */
        function sendData(event) {
            event.preventDefault(); //TODO remove for real tests -> only to not refresh the console
            //upload the file
            sendFile();
            //store the form
            dataToSend = getFormData();
            //if no data to upload -> donst POST
            if (!dataToSend) {
                console.log("Data is empty.");
                return;
            }
            console.log("Sending data: " + dataToSend);
            //the http request will be build
            xhr = getXmlHttpRequestObject();
            xhr.onreadystatechange = sendDataCallback;
            // asynchronous requests
            xhr.open("POST", "http://localhost:6969/users", true);
            xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
            // Send the request over the network
            xhr.send(JSON.stringify({"data": dataToSend}));
        }

    </script>
</body>
</html>
<style>
    #form_object{
        background-color: white;
        margin-top: 1%;
        padding: 12px;
        border-radius: 12px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);;
    }
    body {
        width: 100vw;
        height: 100vh;
        background-color: rgba(192, 192, 192, 0.4);
    }
     /* The snackbar - position it at the bottom and in the middle of the screen */
    #snackbar {
      visibility: hidden; /* Hidden by default. Visible on click */
      min-width: 250px; /* Set a default minimum width */
      margin-left: -125px; /* Divide value of min-width by 2 */
      background-color: #4CAF50; /* Black background color */
      color: #fff; /* White text color */
      text-align: center; /* Centered text */
      border-radius: 2px; /* Rounded borders */
      padding: 16px; /* Padding */
      position: fixed; /* Sit on top of the screen */
      z-index: 1; /* Add a z-index if needed */
      left: 50%; /* Center the snackbar */
      bottom: 30px; /* 30px from the bottom */
    }

    /* Show the snackbar when clicking on a button (class added with JavaScript) */
    #snackbar.show {
      visibility: visible; /* Show the snackbar */
      /* Add animation: Take 0.5 seconds to fade in and out the snackbar.
      However, delay the fade out process for 2.5 seconds */
      -webkit-animation: fadein 0.5s, fadeout 0.5s 2.5s;
      animation: fadein 0.5s, fadeout 0.5s 2.5s;
    }

    /* Animations to fade the snackbar in and out */
    @-webkit-keyframes fadein {
      from {bottom: 0; opacity: 0;}
      to {bottom: 30px; opacity: 1;}
    }

    @keyframes fadein {
      from {bottom: 0; opacity: 0;}
      to {bottom: 30px; opacity: 1;}
    }

    @-webkit-keyframes fadeout {
      from {bottom: 30px; opacity: 1;}
      to {bottom: 0; opacity: 0;}
    }

    @keyframes fadeout {
      from {bottom: 30px; opacity: 1;}
      to {bottom: 0; opacity: 0;}
    }
</style>